<!-- Overlay for mobile -->
<div
  class="sidebar-overlay"
  *ngIf="isOpen"
  (click)="onClose()"
  [@fadeIn]></div>

<!-- Sidebar -->
<aside
  class="conversation-sidebar"
  [class.open]="isOpen"
  [@slideIn]>

  <!-- Sidebar Header -->
  <div class="sidebar-header">
    <button
      mat-icon-button
      (click)="onClose()"
      class="close-button"
      aria-label="Close sidebar">
      <mat-icon>close</mat-icon>
    </button>

    <button
      mat-button
      (click)="onNewChat()"
      class="new-chat-button">
      <mat-icon>add</mat-icon>
      New chat
    </button>
  </div>

  <!-- Conversations List -->
  <div class="conversations-list">
    <div class="list-section">
      <div class="section-title">Recent</div>

      <div
        *ngFor="let conversation of conversations"
        class="conversation-item"
        (click)="onSelectConversation(conversation.id)">

        <div class="conversation-icon">
          <mat-icon>chat_bubble_outline</mat-icon>
        </div>

        <div class="conversation-content">
          <div class="conversation-title">{{ conversation.title }}</div>
          <div class="conversation-time">{{ getRelativeTime(conversation.timestamp) }}</div>
        </div>

        <button
          mat-icon-button
          class="conversation-menu"
          [matMenuTriggerFor]="conversationMenu"
          (click)="$event.stopPropagation()"
          matTooltip="More options">
          <mat-icon>more_vert</mat-icon>
        </button>

        <mat-menu #conversationMenu="matMenu">
          <button mat-menu-item (click)="onRenameConversation($event, conversation)">
            <mat-icon>edit</mat-icon>
            <span>Rename</span>
          </button>
          <button mat-menu-item (click)="onDeleteConversation($event, conversation.id)">
            <mat-icon>delete</mat-icon>
            <span>Delete</span>
          </button>
        </mat-menu>
      </div>

      <div *ngIf="conversations.length === 0" class="empty-state">
        <mat-icon>chat_bubble_outline</mat-icon>
        <p>No conversations yet</p>
        <p class="empty-hint">Start a new chat to get started</p>
      </div>
    </div>
  </div>

  <!-- Usage Display -->
  <div class="usage-section" *ngIf="usage$ | async as usage">
    <div class="usage-header">
      <mat-icon>bar_chart</mat-icon>
      <span>Monthly Usage</span>
    </div>
    <div class="usage-stats">
      <ng-container *ngIf="!isUnlimited(usage.monthlyLimit); else unlimitedUsage">
        <div class="usage-count">
          {{ usage.serversDeployedThisMonth }} / {{ usage.monthlyLimit }} deployments
        </div>
        <mat-progress-bar
          mode="determinate"
          [value]="usage.percentUsed"
          [color]="usage.percentUsed >= 80 ? 'warn' : 'primary'">
        </mat-progress-bar>
        <div class="usage-remaining" *ngIf="usage.remainingDeployments > 0">
          {{ usage.remainingDeployments }} remaining
        </div>
        <div class="usage-limit-reached" *ngIf="usage.remainingDeployments === 0">
          <mat-icon>warning</mat-icon>
          Limit reached - <a routerLink="/account">Upgrade</a>
        </div>
      </ng-container>
      <ng-template #unlimitedUsage>
        <div class="usage-count unlimited">
          <mat-icon>all_inclusive</mat-icon>
          {{ usage.serversDeployedThisMonth }} deployments (unlimited)
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Sidebar Footer -->
  <div class="sidebar-footer">
    <button
      mat-button
      class="footer-button"
      (click)="onSettings()"
      aria-label="Open settings">
      <mat-icon>settings</mat-icon>
      Settings
    </button>
  </div>
</aside>
